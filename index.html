<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>de-ve-de</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
   <div id="welcome"> 
    <h1>The De-Ve-De MovieBase</h1>
    <h4>We keep track on your movies!</h4>
    <img id="logo" src="IMG/Group 6.svg" alt="">
    </div>

    <div id="enterDetails">
       
        <h2>Add your movies</h2>
        <h4>Title</h4>
        <input id="enterTitle" type="text">

        <h4>Genre</h4>
        <input id="enterGenre" type="text">

        <h4>Release Date</h4>
        <input id="enterReleaseDate" type="number"> <br> <br><br><br>

        <button id="insert">ADD MOVIE</button>
        <button id="update">UPDATE MOVIE</button>
        <button id="remove">DELETE MOVIE</button>

    </div>

    <div id="findDetails">
        <h1>Search by Title</h1> 
        <h4>Title</h4>
        <input id="findTitle" type="text"> <br><br>
        <button id="find">SEARCH</button>
        <h3 id="findGenre" type="text"></h3>
        <h3 id="findReleaseDate" type="number"></h3>
        <h3 id="watched"></h3>
        <input id="findWatched" type="checkbox" style="display: none;"><br><br>       
        <button id="showTitlesButton">SHOW ALL YOUR TITLES</button>
        <button id="exportDatabase">DOWNLOAD DATABASE</button>

    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
      
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyD3PWNl_b_hUGYUl3oEjQXqSqNoUErKphc",
          authDomain: "de-ve-de-63d1b.firebaseapp.com",
          databaseURL: "https://de-ve-de-63d1b-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "de-ve-de-63d1b",
          storageBucket: "de-ve-de-63d1b.appspot.com",
          messagingSenderId: "553934058133",
          appId: "1:553934058133:web:4d4006d4f236e3b296219c"
        };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        import {getDatabase, set, get, update, remove, ref, child, onValue}
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"

        const db = getDatabase();

        let enterTitle = document.querySelector("#enterTitle");
        let enterGenre = document.querySelector("#enterGenre");
        let enterReleaseDate = document.querySelector("#enterReleaseDate");
        let findTitle = document.querySelector("#findTitle");
        let findGenre = document.querySelector("#findGenre");
        let findReleaseDate = document.querySelector("#findReleaseDate");
        let watched = document.querySelector("#watched"); 
        let findWatched = document.querySelector("#findWatched");   
        let insertButton = document.querySelector("#insert");
        let updateButton = document.querySelector("#update");
        let removeButton = document.querySelector("#remove");
        let findButton = document.querySelector("#find");
        let showDatabaseButton = document.querySelector("#showDatabase");
        
        function InsertData() {
            const movieRef = ref(db, "Movies/" + enterTitle.value);
            get(movieRef)
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        alert("A movie with the same title already exists!");
                    } else {
                        set(movieRef, {
                            Title: enterTitle.value,
                            Genre: enterGenre.value,
                            ReleaseDate: enterReleaseDate.value
                        })
                        .then(() => {
                            alert("Your movie was saved!");
                        })
                        .catch((error) => {
                            alert(error);
                        });
                    }
                })
                .catch((error) => {
                    alert(error);
                });
        };
        function FindData() {
            const dbref = ref(db);
            get(child(dbref, "Movies/" + findTitle.value))
            .then((snapshot)=>{
                if (snapshot.exists()) {
                    findGenre.innerHTML = "Genre: " + snapshot.val().Genre;
                    findReleaseDate.innerHTML = "Release Date: " + snapshot.val().ReleaseDate;
                    watched.innerHTML = "Watched: ";
                    findWatched.checked = snapshot.val().Watched || false;
                    findWatched.addEventListener('change', function() {
                        update(ref(db, "Movies/" + findTitle.value), {
                            Watched: findWatched.checked
                        })
                        .then(()=>{
                            alert("Watched status updated!");
                        })
                        .catch((error)=>{
                            alert(error);
                        });
                    });
                } else {
                    alert("You don't have a movie with that name, yet!");
                }
            })
            .catch((error)=>{
                alert(error);
            });
            findWatched.style.display = "block";
        };
        function UpdateData() {
            const movieRef = ref(db, "Movies/" + enterTitle.value);
            get(movieRef)
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const updateData = {};
                        const newGenre = enterGenre.value.trim();
                        const newReleaseDate = enterReleaseDate.value.trim();

                        if (newGenre !== '' && snapshot.val().Genre !== newGenre) {
                            updateData['Genre'] = newGenre;
                        }

                        if (newReleaseDate !== '' && snapshot.val().ReleaseDate !== newReleaseDate) {
                            updateData['ReleaseDate'] = newReleaseDate;
                        }

                        if (Object.keys(updateData).length > 0) {
                            update(movieRef, updateData)
                                .then(() => {
                                    alert("The movie was updated!");
                                })
                                .catch((error) => {
                                    alert(error);
                                });
                        } else {
                            alert("No new data provided for update.");
                        }
                    } else {
                        alert("Movie not found!");
                    }
                })
                .catch((error) => {
                    alert(error);
                });
        };

        function RemoveData() {
            remove(ref(db, "Movies/" + enterTitle.value))
            .then(()=>{
                alert("The movie was removed!");
            })
            .catch((error)=>{
                alert(error);
            });
        };

        function ShowTitles() {
             const dbref = ref(db, "Movies");
                  get(dbref)
                 .then((snapshot) => {
               if (snapshot.exists()) {
                    const movies = snapshot.val();
                    const movieEntries = Object.entries(movies);
                    const titlesAndReleaseDates = movieEntries.map(([key, movie]) => `${movie.Title} - ${movie.Genre || 'N/A'}, ${movie.ReleaseDate || 'N/A'} ${movie.Watched ? 'Watched' : 'Not Watched'}`);
                    alert("Movie Titles:\n" + titlesAndReleaseDates.join("\n"));
                } else {
                    alert("Database is empty!");
                }
            })
            .catch((error) => {
                alert(error);
            });
        };

        function exportDatabase() {
            const dbref = ref(db, "Movies");
            get(dbref)
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const movies = snapshot.val();
                        const jsonData = JSON.stringify(movies, null, 2);

                        const blob = new Blob([jsonData], { type: 'application/json' });

                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(blob);
                        a.download = 'movieDatabase.json';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    } else {
                        alert("Database is empty!");
                    }
                })
                .catch((error) => {
                    alert(error);
                });
        };

const exportButton = document.querySelector("#exportDatabase");
exportButton.addEventListener('click', exportDatabase);

        insertButton.addEventListener('click', InsertData);
        updateButton.addEventListener('click', UpdateData);
        removeButton.addEventListener('click', RemoveData);
        findButton.addEventListener('click', FindData);
        showTitlesButton.addEventListener('click', ShowTitles);

    </script>

</body>
</html>
